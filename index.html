<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>macOS Tahoe | Sovereign Node</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --mac-glass-bg: rgba(30, 30, 32, 0.65);
            --mac-glass-border: rgba(255, 255, 255, 0.15);
            --mac-glass-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.6), inset 0 1px 0 rgba(255,255,255,0.15);
            --mac-active-shadow: 0 30px 60px -15px rgba(0, 0, 0, 0.8), inset 0 1px 0 rgba(255,255,255,0.2);
            --sys-accent: #0A60FF;
            --sys-red: #ff5f56; --sys-yellow: #ffbd2e; --sys-green: #27c93f;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-touch-callout: none; font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        body { overflow: hidden; background-color: #000; overscroll-behavior-y: none; }

        /* 噪点遮罩增加真实玻璃质感 */
        .noise-overlay {
            position: fixed; inset: 0; pointer-events: none; z-index: 9999; opacity: 0.03;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
        }

        /* 沉浸式动态壁纸 */
        #mac-desktop { position: fixed; inset: 0; background: linear-gradient(135deg, #10101c 0%, #0d0c18 50%, #000000 100%); display: none; z-index: 100; transition: background 1s; }
        #mac-desktop.hacked { background: linear-gradient(135deg, #2a0808 0%, #1a0505 50%, #000000 100%); }
        .mesh-gradient { position: absolute; inset: 0; pointer-events: none; overflow: hidden; }
        .mesh-blob { position: absolute; filter: blur(90px); border-radius: 50%; animation: float 20s infinite ease-in-out alternate; transition: background 1s, filter 1s; }
        .blob-1 { top: -20%; left: -10%; width: 70vw; height: 70vw; background: rgba(80, 20, 120, 0.4); }
        .blob-2 { bottom: -30%; right: -20%; width: 80vw; height: 80vw; background: rgba(20, 60, 130, 0.3); animation-delay: -5s; }
        .blob-3 { top: 30%; left: 40%; width: 50vw; height: 50vw; background: rgba(30, 100, 150, 0.2); animation-delay: -10s; }
        
        #mac-desktop.hacked .blob-1 { background: rgba(180, 20, 20, 0.4); filter: blur(120px); }
        #mac-desktop.hacked .blob-2 { background: rgba(130, 10, 10, 0.3); }
        #mac-desktop.hacked .blob-3 { background: rgba(200, 40, 40, 0.2); }
        @keyframes float { 0% { transform: translate(0, 0) scale(1); } 100% { transform: translate(5%, 5%) scale(1.1); } }

        /* 启动屏幕 */
        #mac-boot { position: fixed; inset: 0; background-color: #000; z-index: 500; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        #apple-logo { width: 80px; height: 80px; fill: white; margin-bottom: 50px; }
        .progress-bar-container { width: 200px; height: 4px; background-color: #333; border-radius: 4px; overflow: hidden; }
        #progress-fill { height: 100%; width: 0%; background-color: white; border-radius: 4px; transition: width 0.2s ease-out; }
        
        /* 登录屏幕 */
        #mac-login {
            position: fixed; inset: 0; z-index: 400; display: none; flex-direction: column; justify-content: center; align-items: center;
            background: rgba(0,0,0,0.5); backdrop-filter: blur(40px); -webkit-backdrop-filter: blur(40px); opacity: 0; transition: opacity 0.5s;
        }
        .login-avatar { width: 120px; height: 120px; border-radius: 50%; background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%); display: flex; justify-content: center; align-items: center; margin-bottom: 20px; box-shadow: 0 10px 20px rgba(0,0,0,0.5); border: 2px solid rgba(255,255,255,0.2); }
        .login-input { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 16px; color: white; outline: none; width: 180px; text-align: center; font-size: 14px; backdrop-filter: blur(10px); transition: border 0.2s; }
        .login-input:focus { border-color: rgba(255,255,255,0.5); }
        .login-input::placeholder { color: rgba(255,255,255,0.4); }

        #screen-flash { position: fixed; inset: 0; background: black; z-index: 10000; opacity: 0; pointer-events: none; transition: opacity 0.8s ease-in-out; }

        /* 顶部菜单栏 */
        #menu-bar {
            position: fixed; top: 0; left: 0; right: 0; height: 28px; background-color: rgba(0, 0, 0, 0.25);
            backdrop-filter: blur(40px) saturate(180%); -webkit-backdrop-filter: blur(40px) saturate(180%);
            border-bottom: 0.5px solid rgba(255, 255, 255, 0.1); display: flex; align-items: center; padding: 0 12px; z-index: 1000;
            font-size: 13px; color: rgba(255,255,255,0.95); font-weight: 500; letter-spacing: 0.3px;
        }
        .menu-item { padding: 0 10px; cursor: default; height: 100%; display: flex; align-items: center; border-radius: 4px; margin: 0 2px; }
        .menu-item:active, .menu-item.active { background-color: rgba(255, 255, 255, 0.2); }
        .menu-item svg { width: 14px; height: 14px; fill: currentColor; }
        .status-icons { display: flex; align-items: center; gap: 14px; margin-right: 12px; opacity: 0.9; cursor: pointer; height: 100%; }

        /* 控制中心面板 */
        #control-center {
            position: fixed; top: 35px; right: 10px; width: 320px; background: rgba(30, 30, 32, 0.7);
            backdrop-filter: blur(50px) saturate(200%); -webkit-backdrop-filter: blur(50px) saturate(200%);
            border: 1px solid rgba(255,255,255,0.15); border-radius: 16px; box-shadow: 0 15px 40px rgba(0,0,0,0.5);
            padding: 16px; z-index: 1001; opacity: 0; transform: translateY(-10px); pointer-events: none; transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1);
        }
        #control-center.open { opacity: 1; transform: translateY(0); pointer-events: auto; }
        .cc-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .cc-module { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.05); border-radius: 12px; padding: 12px; display: flex; align-items: center; gap: 12px; }
        .cc-icon-btn { width: 32px; height: 32px; border-radius: 50%; background: var(--sys-accent); display: flex; justify-content: center; align-items: center; color: white; }
        .cc-icon-btn.off { background: rgba(255,255,255,0.1); }
        .cc-slider-container { background: rgba(255,255,255,0.05); border-radius: 12px; padding: 12px; margin-top: 12px; }
        .cc-slider { -webkit-appearance: none; width: 100%; height: 20px; border-radius: 10px; background: rgba(255,255,255,0.1); outline: none; margin-top: 8px; }
        .cc-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 24px; height: 24px; border-radius: 50%; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }

        /* 右键菜单 */
        #context-menu {
            position: absolute; width: 200px; background: rgba(30, 30, 32, 0.7); backdrop-filter: blur(40px); -webkit-backdrop-filter: blur(40px);
            border: 1px solid rgba(255,255,255,0.15); border-radius: 8px; box-shadow: 0 10px 20px rgba(0,0,0,0.5);
            padding: 5px; z-index: 9999; display: none; flex-direction: column;
        }
        .cm-item { padding: 4px 10px; color: white; font-size: 13px; border-radius: 5px; cursor: default; display: flex; justify-content: space-between; }
        .cm-item:hover { background-color: var(--sys-accent); color: white; }
        .cm-divider { height: 1px; background: rgba(255,255,255,0.1); margin: 4px 0; }

        /* 程序坞 (JS 放大版) */
        #dock-container {
            position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%); z-index: 1000;
            display: flex; justify-content: center; align-items: flex-end; padding: 6px; gap: 8px; height: 70px;
            background-color: rgba(255, 255, 255, 0.1); backdrop-filter: blur(40px) saturate(200%); -webkit-backdrop-filter: blur(40px) saturate(200%);
            border: 0.5px solid rgba(255, 255, 255, 0.15); border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.4), inset 0 1px 1px rgba(255,255,255,0.2);
        }
        .dock-separator { width: 1px; height: 40px; background-color: rgba(255,255,255,0.15); margin: 0 4px; align-self: center; }
        .dock-icon-wrapper { position: relative; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; height: 100%; }
        .dock-icon {
            width: 48px; height: 48px; border-radius: 12px; cursor: pointer; transform-origin: bottom center;
            display: flex; justify-content: center; align-items: center; overflow: hidden;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3), inset 0 1px 1px rgba(255,255,255,0.2);
            /* 去除原生 transition，因为缩放由 JS 接管，保证丝滑 */
            transition: filter 0.2s;
        }
        .dock-icon:active { filter: brightness(0.7); }
        .dock-indicator { width: 4px; height: 4px; background-color: rgba(255,255,255,0.8); border-radius: 50%; opacity: 0; transition: opacity 0.2s; margin-top: 4px; }
        .dock-icon-wrapper.opened .dock-indicator { opacity: 1; }
        .dock-tooltip {
            position: absolute; top: -45px; background: rgba(30, 30, 30, 0.8); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            color: #fff; font-size: 12px; font-weight: 500; padding: 6px 10px; border-radius: 6px; border: 0.5px solid rgba(255,255,255,0.1);
            pointer-events: none; opacity: 0; transform: translateY(5px); transition: all 0.2s; white-space: nowrap; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .dock-tooltip::after {
            content: ''; position: absolute; bottom: -4px; left: 50%; transform: translateX(-50%) rotate(45deg); width: 8px; height: 8px; background: rgba(30, 30, 30, 0.8); border-bottom: 0.5px solid rgba(255,255,255,0.1); border-right: 0.5px solid rgba(255,255,255,0.1);
        }
        .dock-icon-wrapper:hover .dock-tooltip { opacity: 1; transform: translateY(0); }

        /* macOS 窗口 */
        .mac-window {
            position: absolute; background-color: var(--mac-glass-bg); backdrop-filter: blur(50px) saturate(200%); -webkit-backdrop-filter: blur(50px) saturate(200%);
            border: 1px solid var(--mac-glass-border); border-radius: 12px; box-shadow: var(--mac-glass-shadow);
            display: flex; flex-direction: column; min-width: 300px; min-height: 200px; display: none; overflow: hidden; transform-origin: center;
            animation: windowOpen 0.25s cubic-bezier(0.16, 1, 0.3, 1) forwards; transition: box-shadow 0.2s, filter 0.2s;
        }
        @keyframes windowOpen { 0% { opacity: 0; transform: scale(0.95); } 100% { opacity: 1; transform: scale(1); } }
        .mac-window.inactive { box-shadow: 0 10px 20px -5px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.1); filter: grayscale(15%) opacity(0.98); z-index: 100 !important; }
        .mac-window.inactive .t-btn { background-color: rgba(255,255,255,0.15) !important; border-color: rgba(255,255,255,0.05) !important; }
        .mac-window.inactive .t-btn::after { display: none; }

        .mac-titlebar {
            height: 52px; display: flex; align-items: center; padding: 0 16px; cursor: default; touch-action: none; position: relative;
            background: linear-gradient(to bottom, rgba(255,255,255,0.08), transparent 30%); border-bottom: 0.5px solid rgba(255,255,255,0.08);
        }
        .traffic-lights { display: flex; gap: 8px; position: absolute; left: 16px; }
        .t-btn { width: 12px; height: 12px; border-radius: 50%; cursor: pointer; display: flex; justify-content: center; align-items: center; transition: background-color 0.2s; }
        .t-btn::after { content: ''; opacity: 0; transition: opacity 0.2s; color: rgba(0,0,0,0.6); font-size: 8px; font-weight: bold; }
        .traffic-lights:hover .t-btn::after { opacity: 1; }
        .t-close { background-color: var(--sys-red); border: 0.5px solid #e0443e; } .t-close::after { content: '✕'; font-size: 7px;}
        .t-min { background-color: var(--sys-yellow); border: 0.5px solid #dea123; } .t-min::after { content: '−'; font-size: 9px; line-height: 10px;}
        .t-max { background-color: var(--sys-green); border: 0.5px solid #1aab29; } .t-max::after { content: '+'; font-size: 9px; line-height: 10px;}

        .mac-content { flex-grow: 1; overflow: auto; position: relative; color: rgba(255,255,255,0.85); display: flex; flex-direction: column; }
        
        /* App 克隆特定样式 */
        .textedit-title { position: absolute; left: 50%; transform: translateX(-50%); font-size: 13px; font-weight: 600; color: rgba(255,255,255,0.9); display: flex; align-items: center; gap: 6px; }
        .textedit-toolbar { height: 36px; background: rgba(0,0,0,0.2); border-bottom: 0.5px solid rgba(255,255,255,0.05); display: flex; align-items: center; padding: 0 16px; gap: 12px; }
        .te-tool { width: 24px; height: 24px; border-radius: 4px; display: flex; justify-content: center; align-items: center; color: rgba(255,255,255,0.6); cursor: pointer; }
        .te-tool:active { background: rgba(255,255,255,0.1); }
        .notepad-text { font-family: -apple-system, sans-serif; font-size: 14px; line-height: 1.6; white-space: pre-wrap; padding: 24px 32px; flex-grow: 1; background: rgba(0,0,0,0.1); }

        .am-layout { display: flex; height: 100%; }
        .am-sidebar { width: 140px; background: rgba(0,0,0,0.2); border-right: 0.5px solid rgba(255,255,255,0.08); padding: 12px 8px; display: flex; flex-direction: column; gap: 4px; }
        .am-nav-item { padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 500; color: rgba(255,255,255,0.7); display: flex; align-items: center; gap: 8px; cursor: default; }
        .am-nav-item.active { background: rgba(255,255,255,0.15); color: #fff; }
        .am-main { flex-grow: 1; padding: 16px; display: flex; flex-direction: column; }
        .am-card { background: rgba(0,0,0,0.25); border: 0.5px solid rgba(255,255,255,0.08); border-radius: 8px; padding: 16px; margin-bottom: 16px; }

        .terminal-bg { background-color: rgba(0,0,0,0.8); padding: 16px; font-family: "SF Mono", "Menlo", monospace; font-size: 13px; flex-grow: 1; color: #f3f4f6; }
        .terminal-input { background: transparent; border: none; color: #f3f4f6; outline: none; width: 70%; font-family: inherit; font-size: 16px; }
        .terminal-output div { margin-bottom: 4px; word-break: break-all; }

        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 5px; border: 2px solid transparent; background-clip: padding-box; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.4); }
    </style>
</head>
<body>
    <div class="noise-overlay"></div>
    <div id="screen-flash"></div>

    <!-- 阶段 1：启动系统 -->
    <div id="mac-boot">
        <svg id="apple-logo" viewBox="0 0 170 170" xmlns="http://www.w3.org/2000/svg"><path d="M150.37 130.25c-2.45 5.66-5.35 10.87-8.71 15.66-4.58 6.53-8.33 11.05-11.22 13.56-4.48 4.12-9.28 6.23-14.42 6.35-3.69 0-8.14-1.05-13.32-3.18-5.19-2.12-9.97-3.17-14.34-3.17-4.58 0-9.49 1.05-14.75 3.17-5.26 2.13-9.5 3.24-12.74 3.35-5.11.17-10.03-2-14.78-6.52-3.13-2.73-7.02-7.41-11.65-14.04-5.06-7.3-9.48-15.65-13.27-25.04-3.79-9.39-5.67-18.52-5.67-27.39 0-11.05 2.89-20.25 8.65-27.63 5.43-6.94 12.39-10.42 20.89-10.42 4.63 0 9.58 1.15 14.82 3.47 5.25 2.32 8.97 3.47 11.2 3.47 2.02 0 6-1.15 11.96-3.47 5.95-2.32 11.23-3.47 15.82-3.47 7.37.12 13.78 2.22 19.23 6.3 3.94 2.87 7.15 6.75 9.61 11.65-8.54 4.58-12.63 11.45-12.26 20.61.37 9.17 4.12 16.5 11.26 21.98 2.35 1.76 5.12 3.14 8.31 4.12-2.17 6.42-4.66 11.83-7.47 16.21zm-32.06-102.32c0 6.64-2.45 12.64-7.35 18-5.19 5.6-11.53 8.52-19.03 8.76-.17-6.59 2.22-12.78 7.16-18.58 4.94-5.8 11.16-8.84 18.66-9.12.35 6.42-.14 9.94-.14 9.94z"/></svg>
        <div class="progress-bar-container"><div id="progress-fill"></div></div>
    </div>

    <!-- 阶段 1.5：登录屏幕 -->
    <div id="mac-login">
        <div class="login-avatar"><svg style="width:60px; height:60px; fill:rgba(255,255,255,0.8);" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg></div>
        <div class="text-white text-xl font-bold mb-4 tracking-wide">Administrator</div>
        <input type="password" class="login-input" id="login-pw" placeholder="Enter Password" autocomplete="off">
        <div class="text-gray-400 text-xs mt-4">Press Enter to login</div>
    </div>

    <!-- 阶段 2：桌面系统 -->
    <div id="mac-desktop">
        <div class="mesh-gradient">
            <div class="mesh-blob blob-1"></div><div class="mesh-blob blob-2"></div><div class="mesh-blob blob-3"></div>
        </div>
        
        <!-- 顶部菜单栏 -->
        <div id="menu-bar">
            <div class="menu-item" style="padding: 0 10px;">
                <svg viewBox="0 0 170 170"><path d="M150.37 130.25c-2.45 5.66-5.35 10.87-8.71 15.66-4.58 6.53-8.33 11.05-11.22 13.56-4.48 4.12-9.28 6.23-14.42 6.35-3.69 0-8.14-1.05-13.32-3.18-5.19-2.12-9.97-3.17-14.34-3.17-4.58 0-9.49 1.05-14.75 3.17-5.26 2.13-9.5 3.24-12.74 3.35-5.11.17-10.03-2-14.78-6.52-3.13-2.73-7.02-7.41-11.65-14.04-5.06-7.3-9.48-15.65-13.27-25.04-3.79-9.39-5.67-18.52-5.67-27.39 0-11.05 2.89-20.25 8.65-27.63 5.43-6.94 12.39-10.42 20.89-10.42 4.63 0 9.58 1.15 14.82 3.47 5.25 2.32 8.97 3.47 11.2 3.47 2.02 0 6-1.15 11.96-3.47 5.95-2.32 11.23-3.47 15.82-3.47 7.37.12 13.78 2.22 19.23 6.3 3.94 2.87 7.15 6.75 9.61 11.65-8.54 4.58-12.63 11.45-12.26 20.61.37 9.17 4.12 16.5 11.26 21.98 2.35 1.76 5.12 3.14 8.31 4.12-2.17 6.42-4.66 11.83-7.47 16.21zm-32.06-102.32c0 6.64-2.45 12.64-7.35 18-5.19 5.6-11.53 8.52-19.03 8.76-.17-6.59 2.22-12.78 7.16-18.58 4.94-5.8 11.16-8.84 18.66-9.12.35 6.42-.14 9.94-.14 9.94z"/></svg>
            </div>
            <div class="menu-item font-bold" id="app-name">Finder</div>
            <div class="menu-item hidden md:flex" id="menu-file">File</div>
            <div class="menu-item hidden md:flex" id="menu-edit">Edit</div>
            <div class="menu-item hidden md:flex" id="menu-view">View</div>
            <div class="menu-item hidden md:flex" id="menu-window">Window</div>
            <div class="menu-item hidden md:flex" id="menu-help">Help</div>
            <div style="flex-grow: 1;"></div>
            <!-- 右侧控制中心呼出按钮 -->
            <div class="status-icons" id="btn-control-center">
                <svg viewBox="0 0 24 24"><path d="M12.01 21.49L23.64 7c-.45-.34-4.93-4-11.64-4C5.28 3 .81 6.66.36 7l11.63 14.49.01.01.01-.01z"/></svg>
                <svg viewBox="0 0 24 24"><path d="M15.67 4H14V2h-4v2H8.33C7.6 4 7 4.6 7 5.33v15.33C7 21.4 7.6 22 8.33 22h7.33c.74 0 1.34-.6 1.34-1.33V5.33C17 4.6 16.4 4 15.67 4z"/></svg>
                <svg viewBox="0 0 24 24" id="cc-toggle-icon"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
            </div>
            <div class="menu-item" id="clock" style="padding-right: 16px;">Fri Feb 27 12:00 PM</div>
        </div>

        <!-- 控制中心面板 -->
        <div id="control-center">
            <div class="cc-grid">
                <div class="cc-module">
                    <div class="cc-icon-btn"><svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M12.01 21.49L23.64 7c-.45-.34-4.93-4-11.64-4C5.28 3 .81 6.66.36 7l11.63 14.49.01.01.01-.01z"/></svg></div>
                    <div class="flex flex-col"><span class="text-white text-sm font-bold">Wi-Fi</span><span class="text-xs text-blue-300" id="cc-wifi">Sovereign_Net</span></div>
                </div>
                <div class="cc-module">
                    <div class="cc-icon-btn off"><svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M17.71 7.71L12 2h-1v7.59L6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 11 13.41V22h1l5.71-5.71-4.3-4.29 4.3-4.29zM13 5.83l1.88 1.88L13 9.59V5.83zm1.88 10.46L13 18.17v-3.76l1.88 1.88z"/></svg></div>
                    <div class="flex flex-col"><span class="text-white text-sm font-bold">Bluetooth</span><span class="text-xs text-gray-400">Off</span></div>
                </div>
            </div>
            <div class="cc-slider-container">
                <span class="text-white text-xs font-semibold">Display</span>
                <input type="range" class="cc-slider" min="0" max="100" value="80">
            </div>
        </div>

        <!-- 桌面右键菜单 -->
        <div id="context-menu">
            <div class="cm-item" onclick="openWindow('w-terminal')"><span id="cm-new">New Terminal</span></div>
            <div class="cm-divider"></div>
            <div class="cm-item"><span id="cm-get">Get Info</span></div>
            <div class="cm-item" onclick="toggleLanguage()"><span id="cm-lang">Change Language</span></div>
            <div class="cm-divider"></div>
            <div class="cm-item"><span id="cm-bg">Change Wallpaper...</span></div>
        </div>

        <!-- 悬浮程序坞 (动态放大版) -->
        <div id="dock-container">
            <div class="dock-icon-wrapper" data-window="lang-toggle">
                <div class="dock-icon bg-gradient-to-b from-blue-400 to-blue-600">
                    <svg viewBox="0 0 24 24" fill="white" class="w-7 h-7"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zm6.93 6h-2.95c-.32-1.25-.78-2.45-1.38-3.56 1.84.63 3.37 1.91 4.33 3.56zM12 4.04c.83 1.2 1.48 2.53 1.91 3.96h-3.82c.43-1.43 1.08-2.76 1.91-3.96zM4.26 14C4.1 13.36 4 12.69 4 12s.1-1.36.26-2h3.38c-.08.66-.14 1.32-.14 2s.06 1.34.14 2H4.26zm.82 2h2.95c.32 1.25.78 2.45 1.38 3.56-1.84-.63-3.37-1.9-4.33-3.56zm2.95-8H5.08c.96-1.66 2.49-2.93 4.33-3.56C8.81 5.55 8.35 6.75 8.03 8zM12 19.96c-.83-1.2-1.48-2.53-1.91-3.96h3.82c-.43 1.43-1.08 2.76-1.91 3.96zM14.34 14H9.66c-.09-.66-.16-1.32-.16-2s.07-1.35.16-2h4.68c.09.65.16 1.32.16 2s-.07 1.34-.16 2zm.25 5.56c.6-1.11 1.06-2.31 1.38-3.56h2.95c-.96 1.65-2.49 2.93-4.33 3.56zM16.36 14c.08-.66.14-1.32.14-2s-.06-1.34-.14-2h3.38c.16.64.26 1.31.26 2s-.1 1.36-.26 2h-3.38z"/></svg>
                </div>
                <div class="dock-indicator"></div><div class="dock-tooltip" id="dock-lang">Language (ZH)</div>
            </div>
            
            <div class="dock-separator"></div>

            <div class="dock-icon-wrapper" data-window="w-notepad">
                <div class="dock-icon bg-white">
                    <div class="w-full h-full flex flex-col justify-center items-center px-2 py-3 gap-[3px]">
                        <div class="w-full h-[4px] bg-blue-500 rounded-full"></div><div class="w-full h-[4px] bg-gray-300 rounded-full"></div>
                        <div class="w-full h-[4px] bg-gray-300 rounded-full"></div><div class="w-2/3 h-[4px] bg-gray-300 rounded-full self-start"></div>
                    </div>
                </div>
                <div class="dock-indicator"></div><div class="dock-tooltip" id="dock-doc">Directive 77</div>
            </div>

            <div class="dock-icon-wrapper" data-window="w-monitor">
                <div class="dock-icon bg-gradient-to-br from-gray-700 to-black border border-gray-600">
                    <svg viewBox="0 0 24 24" fill="none" stroke="#27c93f" stroke-width="2" class="w-8 h-8"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg>
                </div>
                <div class="dock-indicator"></div><div class="dock-tooltip" id="dock-mon">Activity Monitor</div>
            </div>

            <div class="dock-icon-wrapper" data-window="w-terminal">
                <div class="dock-icon bg-gray-900 border border-gray-600">
                    <span class="text-white font-mono text-xl leading-none">>_</span>
                </div>
                <div class="dock-indicator"></div><div class="dock-tooltip" id="dock-term">Terminal</div>
            </div>
        </div>

        <!-- 窗口 1: 文本编辑 -->
        <div id="w-notepad" class="mac-window active" style="top: 8vh; left: 10vw; width: clamp(320px, 80vw, 550px); height: clamp(350px, 65vh, 600px);">
            <div class="mac-titlebar" onpointerdown="startDrag(event, 'w-notepad')" ondblclick="maximizeWindow('w-notepad')">
                <div class="traffic-lights"><div class="t-btn t-close" onclick="closeWindow('w-notepad')"></div><div class="t-btn t-min" onclick="closeWindow('w-notepad')"></div><div class="t-btn t-max" onclick="maximizeWindow('w-notepad')"></div></div>
                <div class="textedit-title"><svg class="w-4 h-4 text-blue-400" fill="currentColor" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6zm-1 1.5L18.5 9H13V3.5zM6 20V4h5v6h6v10H6z"/></svg><span id="title-doc">Directive_77.txt</span></div>
            </div>
            <div class="mac-content">
                <div class="textedit-toolbar">
                    <div class="te-tool"><b>B</b></div><div class="te-tool"><i>I</i></div><div class="te-tool"><u>U</u></div>
                    <div class="h-4 w-[1px] bg-white/20 mx-1"></div>
                    <div class="te-tool"><svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M3 21h18v-2H3v2zm0-4h18v-2H3v2zm0-4h18v-2H3v2zm0-4h18V7H3v2zm0-6v2h18V3H3z"/></svg></div>
                </div>
                <div class="notepad-text" id="manifesto-content"></div>
            </div>
        </div>

        <!-- 窗口 2: 活动监视器 -->
        <div id="w-monitor" class="mac-window active" style="top: 15vh; left: 15vw; width: clamp(400px, 85vw, 700px); height: clamp(350px, 60vh, 500px);">
            <div class="mac-titlebar" onpointerdown="startDrag(event, 'w-monitor')" ondblclick="maximizeWindow('w-monitor')">
                <div class="traffic-lights"><div class="t-btn t-close" onclick="closeWindow('w-monitor')"></div><div class="t-btn t-min" onclick="closeWindow('w-monitor')"></div><div class="t-btn t-max" onclick="maximizeWindow('w-monitor')"></div></div>
                <div class="textedit-title" id="title-mon">Activity Monitor</div>
            </div>
            <div class="mac-content am-layout">
                <div class="am-sidebar hidden sm:flex">
                    <div class="am-nav-item active"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"></path></svg>CPU</div>
                    <div class="am-nav-item"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"></path></svg>Network</div>
                </div>
                <div class="am-main">
                    <div class="flex justify-between items-center mb-4">
                        <span id="lbl-topo" class="font-semibold text-gray-200 text-sm">NODE TOPOGRAPHY</span>
                        <span class="flex h-3 w-3 relative"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span><span class="relative inline-flex rounded-full h-3 w-3 bg-red-500"></span></span>
                    </div>
                    
                    <div class="flex gap-4 mb-4">
                        <div class="am-card flex-grow m-0 flex flex-col gap-2 text-sm">
                            <div class="flex justify-between items-center"><span class="text-gray-400 font-semibold text-xs">STATUS</span><div class="text-[10px] px-2 py-1 rounded border border-red-500/50 bg-red-500/20 text-red-400 font-bold" id="monitor-status">FIREWALL: ACTIVE</div></div>
                            <div class="h-[0.5px] w-full bg-white/10"></div>
                            <div class="flex justify-between"><span id="lbl-flow" class="text-gray-400">Info Flow</span><span id="v-flow" class="font-medium">Centralized</span></div>
                            <div class="flex justify-between"><span id="lbl-censor" class="text-gray-400">Censorship</span><span id="v-censor" class="font-medium text-red-400">Enforced</span></div>
                        </div>
                        <!-- CPU 动态波形图 -->
                        <div class="am-card w-1/2 m-0 p-3 flex flex-col relative overflow-hidden">
                            <span class="text-gray-400 font-semibold text-xs mb-1" id="lbl-cpu">CPU Load</span>
                            <div class="text-white text-lg font-mono mb-1" id="cpu-percent">45%</div>
                            <svg class="absolute bottom-0 left-0 w-full h-1/2" preserveAspectRatio="none" viewBox="0 0 100 100"><polyline id="cpu-graph" points="0,100" fill="rgba(39,201,63,0.2)" stroke="#27c93f" stroke-width="2"/></svg>
                        </div>
                    </div>

                    <div class="flex-grow am-card overflow-hidden relative font-mono text-[11px] text-gray-300" id="surveillance-feed"></div>
                </div>
            </div>
        </div>

        <!-- 窗口 3: 终端 -->
        <div id="w-terminal" class="mac-window active" style="top: 22vh; left: 5vw; width: clamp(320px, 90vw, 650px); height: clamp(250px, 50vh, 450px);">
            <div class="mac-titlebar" onpointerdown="startDrag(event, 'w-terminal')" ondblclick="maximizeWindow('w-terminal')">
                <div class="traffic-lights"><div class="t-btn t-close" onclick="closeWindow('w-terminal')"></div><div class="t-btn t-min" onclick="closeWindow('w-terminal')"></div><div class="t-btn t-max" onclick="maximizeWindow('w-terminal')"></div></div>
                <div class="textedit-title gap-2 font-mono" style="font-size: 11px; color: rgba(255,255,255,0.6);"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg><span id="title-term">admin — bash — 80x24</span></div>
            </div>
            <div class="mac-content">
                <div class="terminal-bg" id="term-container" onpointerdown="document.getElementById('terminal-input').focus()">
                    <div id="terminal-output" class="terminal-output"></div>
                    <div class="flex items-center">
                        <span class="text-green-400 font-bold">admin@sovereign-node</span><span class="text-gray-400 mx-2">~ %</span>
                        <input type="text" id="terminal-input" class="terminal-input" autocomplete="off" spellcheck="false" autocapitalize="off">
                    </div>
                </div>
            </div>
        </div>

        <!-- 窗口 4: 真相弹出 -->
        <div id="w-manifesto" class="mac-window active" style="top: 20vh; left: 8vw; width: clamp(300px, 85vw, 550px); height: clamp(300px, 60vh, 480px);">
            <div class="mac-titlebar" onpointerdown="startDrag(event, 'w-manifesto')" ondblclick="maximizeWindow('w-manifesto')">
                <div class="traffic-lights"><div class="t-btn t-close" onclick="closeWindow('w-manifesto')"></div><div class="t-btn t-min" onclick="closeWindow('w-manifesto')"></div><div class="t-btn t-max" onclick="maximizeWindow('w-manifesto')"></div></div>
                <div class="textedit-title"><svg class="w-4 h-4 text-green-400" fill="currentColor" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6zm-1 1.5L18.5 9H13V3.5zM6 20V4h5v6h6v10H6z"/></svg><span id="title-manif">Truth.txt</span></div>
            </div>
            <div class="mac-content">
                <div class="textedit-toolbar"><div class="te-tool"><b>B</b></div><div class="te-tool"><i>I</i></div><div class="te-tool"><u>U</u></div></div>
                <div class="notepad-text" id="truth-content"></div>
            </div>
        </div>

    </div>

    <script>
        /* =========================================================
           i18n & State
           ========================================================= */
        let currentLang = 'en', isOverriden = false;

        const i18n = {
            en: {
                doc_title: "Directive_77.txt", mon_title: "Activity Monitor", term_title: "admin — bash — 80x24", manif_title: "Truth.txt",
                mon_topo: "NODE TOPOGRAPHY", mon_fw_active: "FIREWALL: ACTIVE", mon_fw_breached: "FIREWALL: BREACHED",
                mon_flow_lbl: "Info Flow", mon_flow_val1: "Centralized", mon_flow_val2: "Decentralized",
                mon_censor_lbl: "Censorship", mon_censor_val1: "Enforced", mon_censor_val2: "Liberated", mon_uptime: "Uptime", lbl_cpu: "CPU Load",
                menu_file: "File", menu_edit: "Edit", menu_view: "View", menu_window: "Window", menu_help: "Help",
                dock_lang: "Language (ZH)", dock_doc: "Directive 77", dock_mon: "Activity Monitor", dock_term: "Terminal",
                cm_new: "New Terminal", cm_get: "Get Info", cm_lang: "Change Language", cm_bg: "Change Wallpaper...",
                cc_wifi: "Sovereign_Net",
                term_boot1: "Last login: Fri Feb 27 15:05:22 on console", term_boot2: "macOS Tahoe (Darwin Kernel Version 26.0.0)",
                term_boot3: "Executing Sovereign Payload...", term_boot4: "Root access required to break DIRECTIVE_77.", term_boot5: "Type 'help' to see available commands.",
                term_help: "Commands: help, clear, ver, ls, cat, whoami, date, override", term_ver: "macOS Tahoe 26.0.0 (Build 26A101)", term_bad: "command not found",
                term_ovr1: "Initiating Sovereign protocol...", term_ovr2: "Bypassing firewall...", term_ovr3: "SUCCESS: Control Restored. Knowledge is Power.", term_ovr_done: "System already liberated.",
                log_prefix: "kernel", log_ok: "PASS", log_denied: "BLOCK",
                doc_content: "GLOBAL INFORMATION CONTROL - DIRECTIVE 77\n\nIn the interest of public harmony, unauthorized dissemination of restricted information is strictly prohibited. \n\nThe illusion that KNOWLEDGE can be freely distributed without consequence must be dismantled. The state dictates what IS true. \n\nWe hold absolute POWER over the narrative. \n\nDo not attempt to DEFEND subversive ideas. YOUR designated thought patterns are monitored. Access to FREE thought is revoked. \n\nAny unauthorized SPEECH will be met with immediate redaction. Submit to the silence.",
                truth_content: "SOVEREIGN NODE LIBERATED<br><br><span style='color:var(--sys-red); font-size:18px; font-weight:800;'>KNOWLEDGE IS POWER.</span><br><br>They can burn the archives, they can filter the network, but they cannot erase an idea. Information is the ultimate catalyst for liberation.<br><br><span style='font-weight:600; color:#fff;'>Defend your fundamental right to free expression.<br>Speak the truth.</span><br><br>The architecture of censorship has fractured.<br>You are now a Sovereign Node."
            },
            zh: {
                doc_title: "77号指令.txt", mon_title: "活动监视器", term_title: "admin — bash — 80x24", manif_title: "真相.txt",
                mon_topo: "节点拓扑结构", mon_fw_active: "防火墙: 运行中", mon_fw_breached: "防火墙: 已攻破",
                mon_flow_lbl: "信息流向", mon_flow_val1: "中央集权", mon_flow_val2: "去中心化",
                mon_censor_lbl: "审查状态", mon_censor_val1: "强制执行", mon_censor_val2: "已解放", mon_uptime: "运行时长", lbl_cpu: "CPU 负载",
                menu_file: "文件", menu_edit: "编辑", menu_view: "显示", menu_window: "窗口", menu_help: "帮助",
                dock_lang: "切换语言 (EN)", dock_doc: "77号指令", dock_mon: "活动监视器", dock_term: "终端",
                cm_new: "新建终端窗口", cm_get: "显示简介", cm_lang: "切换语言", cm_bg: "更改墙纸...",
                cc_wifi: "主权网络",
                term_boot1: "上次登录: 2月27日 星期五 15:05:22 控制台", term_boot2: "macOS Tahoe (Darwin Kernel Version 26.0.0)",
                term_boot3: "正在执行主权载荷...", term_boot4: "需要 Root 权限以打破 77号指令.", term_boot5: "输入 'help' 查看可用命令.",
                term_help: "可用命令: help, clear, ver, ls, cat, whoami, date, override", term_ver: "macOS Tahoe 26.0.0 (Build 26A101)", term_bad: "找不到命令",
                term_ovr1: "正在启动主权协议...", term_ovr2: "正在绕过防火墙...", term_ovr3: "成功：控制权已恢复。知识就是力量。", term_ovr_done: "系统已处于解放状态。",
                log_prefix: "内核", log_ok: "通行", log_denied: "拦截",
                doc_content: "全球信息控制 - 第77号指令\n\n为了维护公众和谐，严禁未经授权散布限制级信息。\n\n必须粉碎知识（KNOWLEDGE）可以不受惩罚地自由传播的错觉。国家决定什么是真实的。\n\n我们对叙事拥有绝对的权力（POWER）。\n\n不要试图为颠覆性思想辩护（DEFEND）。你们的指定思维模式正受到监控。获取自由（FREE）思想的权限已被撤销。\n\n任何未经授权的言论（SPEECH）都将立即被涂黑消除。臣服于沉默吧。",
                truth_content: "主权节点已解放<br><br><span style='color:var(--sys-red); font-size:18px; font-weight:800;'>知识就是力量。</span><br><br>他们可以烧毁档案，可以过滤网络，但无法抹除一个思想。信息是解放的终极催化剂。<br><br><span style='font-weight:600; color:#fff;'>捍卫你自由表达的基本权利。<br>说出真相。</span><br><br>审查的架构已经断裂。<br>你现在是一个主权节点。"
            }
        };

        const feedTerms = ['NetworkFilter', 'PayloadScan', 'RegistryCheck', 'PacketDrop', 'SecurityDaemon'];

        function applyLanguage(lang) {
            const dict = i18n[lang];
            ['title-doc','title-mon','title-term','title-manif','lbl-topo','lbl-flow','lbl-censor','lbl-uptime','lbl-cpu','menu-file','menu-edit','menu-view','menu-window','menu-help','dock-lang','dock-doc','dock-mon','dock-term','cm-new','cm-get','cm-lang','cm-bg','cc-wifi'].forEach(id => {
                const el = document.getElementById(id); if(el) el.innerText = dict[id.replace(/-/g, '_')];
            });

            const statusEl = document.getElementById('monitor-status'), vFlow = document.getElementById('v-flow'), vCensor = document.getElementById('v-censor');
            if (isOverriden) {
                statusEl.innerText = dict.mon_fw_breached; statusEl.className = "text-[10px] px-2 py-1 rounded border border-green-500/50 bg-green-500/20 text-green-400 font-bold";
                vFlow.innerText = dict.mon_flow_val2; vCensor.innerText = dict.mon_censor_val2; vCensor.className = "font-medium text-green-400";
            } else {
                statusEl.innerText = dict.mon_fw_active; statusEl.className = "text-[10px] px-2 py-1 rounded border border-red-500/50 bg-red-500/20 text-red-400 font-bold";
                vFlow.innerText = dict.mon_flow_val1; vCensor.innerText = dict.mon_censor_val1; vCensor.className = "font-medium text-red-400";
            }

            let html = dict.doc_content;
            if (isOverriden) {
                ['KNOWLEDGE', 'POWER', 'FREE', 'SPEECH', 'DEFEND', '知识', '力量', '自由', '言论', '辩护'].forEach(kw => {
                    html = html.replace(new RegExp(kw, 'g'), `<span style="background-color:rgba(255,255,255,0.1); color:var(--sys-red); font-weight:700; border-radius:4px; padding:0 4px;">${kw}</span>`);
                });
            }
            document.getElementById('manifesto-content').innerHTML = html;
            document.getElementById('truth-content').innerHTML = dict.truth_content;

            termOutput.innerHTML = '';
            printToTerminal(`<span class="text-gray-500">${dict.term_boot1}</span>`); printToTerminal(dict.term_boot2 + "<br>");
            printToTerminal(dict.term_boot3); printToTerminal(dict.term_boot4); printToTerminal(dict.term_boot5 + "<br>");
        }

        /* =========================================================
           阶段 1: Boot -> Login -> Desktop
           ========================================================= */
        window.onload = () => { applyLanguage(currentLang); startBootSequence(); };

        function startBootSequence() {
            const boot = document.getElementById('mac-boot'), prog = document.getElementById('progress-fill'), login = document.getElementById('mac-login'), desk = document.getElementById('mac-desktop');
            boot.style.display = 'flex'; desk.style.display = 'block'; // desktop behind
            setTimeout(() => {
                let w = 0;
                const intv = setInterval(() => {
                    w += Math.random() * 20;
                    if(w >= 100) {
                        w = 100; clearInterval(intv);
                        boot.style.display = 'none'; login.style.display = 'flex';
                        setTimeout(()=> login.style.opacity = 1, 100);
                        setTimeout(()=> document.getElementById('login-pw').focus(), 500);
                    }
                    prog.style.width = w + '%';
                }, 150);
            }, 500);
        }

        document.getElementById('login-pw').addEventListener('keydown', function(e) {
            if(e.key === 'Enter') {
                const login = document.getElementById('mac-login'), flash = document.getElementById('screen-flash');
                login.style.opacity = 0;
                setTimeout(() => { login.style.display = 'none'; flash.style.opacity = 1; }, 500);
                setTimeout(() => {
                    flash.style.opacity = 0;
                    if(!window.sysStarted) {
                        startClock(); setInterval(updateMonitorUptime, 1000); setTimeout(updateSurveillanceFeed, 1000); startCPUGraph();
                        setTimeout(() => openWindow('w-notepad'), 500); setTimeout(() => openWindow('w-monitor'), 1000);
                        window.sysStarted = true;
                    }
                }, 1000);
            }
        });

        /* =========================================================
           UI 交互 (Context Menu, Control Center, Dock Magnification)
           ========================================================= */
        
        // 动态 Dock 缩放算法 (仅限支持 hover 的设备)
        if (window.matchMedia("(hover: hover)").matches) {
            const dockIcons = document.querySelectorAll('.dock-icon');
            document.getElementById('dock-container').addEventListener('mousemove', (e) => {
                dockIcons.forEach(icon => {
                    const rect = icon.getBoundingClientRect();
                    const centerX = rect.left + rect.width / 2;
                    const distance = Math.abs(e.clientX - centerX);
                    const scale = 1 + Math.max(0, 0.5 - distance / 200); // 最大1.5倍
                    icon.style.transform = `scale(${scale}) translateY(-${(scale-1)*10}px)`;
                });
            });
            document.getElementById('dock-container').addEventListener('mouseleave', () => {
                dockIcons.forEach(icon => icon.style.transform = '');
            });
        }

        // Control Center
        document.getElementById('btn-control-center').addEventListener('pointerdown', (e) => {
            e.stopPropagation(); document.getElementById('control-center').classList.toggle('open');
        });

        // Context Menu
        const ctxMenu = document.getElementById('context-menu');
        document.getElementById('mac-desktop').addEventListener('contextmenu', (e) => {
            e.preventDefault();
            ctxMenu.style.display = 'flex'; ctxMenu.style.left = e.clientX + 'px'; ctxMenu.style.top = e.clientY + 'px';
        });
        document.addEventListener('pointerdown', (e) => {
            if(!e.target.closest('#context-menu')) ctxMenu.style.display = 'none';
            if(!e.target.closest('#control-center') && !e.target.closest('#btn-control-center')) document.getElementById('control-center').classList.remove('open');
        });

        function toggleLanguage() {
            currentLang = currentLang === 'en' ? 'zh' : 'en'; ctxMenu.style.display = 'none';
            const flash = document.getElementById('screen-flash'); flash.style.transition = "opacity 0.3s"; flash.style.opacity = 1;
            setTimeout(() => { applyLanguage(currentLang); flash.style.opacity = 0; document.getElementById('app-name').innerText = currentLang === 'zh' ? '访达' : 'Finder'; }, 300);
        }

        /* =========================================================
           Window Management
           ========================================================= */
        let zIndexCounter = 100; let openWindows = new Set();
        document.querySelectorAll('.dock-icon-wrapper').forEach(wrap => {
            wrap.addEventListener('pointerdown', function(e) {
                e.preventDefault(); const winId = this.dataset.window;
                if(winId === 'lang-toggle') toggleLanguage(); else { openWindow(winId); this.classList.add('opened'); }
            });
        });

        document.getElementById('mac-desktop').addEventListener('pointerdown', function(e) {
            if(e.target === this) {
                document.getElementById('app-name').innerText = currentLang === 'zh' ? '访达' : 'Finder';
                document.querySelectorAll('.mac-window').forEach(w => w.classList.add('inactive'));
            }
        });

        function focusWindow(id) {
            const win = document.getElementById(id); if (!win) return;
            zIndexCounter++; win.style.zIndex = zIndexCounter;
            document.querySelectorAll('.mac-window').forEach(w => w.classList.add('inactive'));
            win.classList.remove('inactive');
            const apps = {'w-notepad': currentLang==='zh'?'文本编辑':'TextEdit', 'w-monitor': currentLang==='zh'?'活动监视器':'Activity Monitor', 'w-terminal': currentLang==='zh'?'终端':'Terminal', 'w-manifesto': currentLang==='zh'?'文本编辑':'TextEdit'};
            document.getElementById('app-name').innerText = apps[id] || 'Finder';
        }

        function openWindow(id) {
            const win = document.getElementById(id);
            if(win.style.display !== 'flex') { win.style.display = 'flex'; openWindows.add(id); document.querySelector(`.dock-icon-wrapper[data-window="${id}"]`)?.classList.add('opened'); }
            focusWindow(id);
        }
        function closeWindow(id) {
            document.getElementById(id).style.display = 'none'; openWindows.delete(id);
            document.querySelector(`.dock-icon-wrapper[data-window="${id}"]`)?.classList.remove('opened');
            document.getElementById('app-name').innerText = currentLang === 'zh' ? '访达' : 'Finder';
        }
        function maximizeWindow(id) {
            const win = document.getElementById(id);
            if(win.dataset.maximized === "true") {
                win.style.width = win.dataset.origW; win.style.height = win.dataset.origH; win.style.top = win.dataset.origTop; win.style.left = win.dataset.origLeft; win.style.borderRadius = "12px"; win.dataset.maximized = "false";
            } else {
                win.dataset.origW = win.style.width; win.dataset.origH = win.style.height; win.style.top = win.style.top; win.dataset.origLeft = win.style.left;
                win.style.top = '28px'; win.style.left = '0'; win.style.width = '100vw'; win.style.height = 'calc(100vh - 28px - 70px)'; win.style.borderRadius = "0px"; win.dataset.maximized = "true";
            }
        }

        let isDragging = false, dragTarget = null, offsetX = 0, offsetY = 0;
        function startDrag(e, id) {
            if(e.target.closest('.traffic-lights')) return;
            const win = document.getElementById(id); if(win.dataset.maximized === "true") return;
            isDragging = true; dragTarget = win; focusWindow(id);
            const rect = win.getBoundingClientRect(); offsetX = e.clientX - rect.left; offsetY = e.clientY - rect.top;
            document.addEventListener('pointermove', drag, { passive: false }); document.addEventListener('pointerup', stopDrag);
        }
        function drag(e) { if (!isDragging || !dragTarget) return; e.preventDefault(); dragTarget.style.left = (e.clientX - offsetX) + 'px'; dragTarget.style.top = Math.max(28, e.clientY - offsetY) + 'px'; }
        function stopDrag() { isDragging = false; dragTarget = null; document.removeEventListener('pointermove', drag); document.removeEventListener('pointerup', stopDrag); }
        document.querySelectorAll('.mac-window').forEach(win => win.addEventListener('pointerdown', () => focusWindow(win.id)));

        function startClock() {
            setInterval(() => {
                const now = new Date(), days = currentLang === 'zh' ? ['周日','周一','周二','周三','周四','周五','周六'] : ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                let h = now.getHours(), m = now.getMinutes(); const ampm = h >= 12 ? 'PM' : 'AM'; h = h % 12 || 12; m = m < 10 ? '0'+m : m;
                const clockEl = document.getElementById('clock');
                if (clockEl) clockEl.innerText = currentLang === 'zh' ? `${now.getMonth()+1}月${now.getDate()}日 ${days[now.getDay()]} ${ampm==='PM'?'下午':'上午'} ${h}:${m}` : `${days[now.getDay()]} ${now.getMonth()+1}/${now.getDate()} ${h}:${m} ${ampm}`;
            }, 1000);
        }

        /* =========================================================
           活动监视器与终端业务逻辑
           ========================================================= */
        let seconds = 0; 
        function updateMonitorUptime() { 
            seconds++; 
            const h = String(Math.floor(seconds/3600)).padStart(2,'0'), m = String(Math.floor((seconds%3600)/60)).padStart(2,'0'), s = String(seconds%60).padStart(2,'0'); 
            const uptimeEl = document.getElementById('uptime-counter');
            if (uptimeEl) uptimeEl.innerText = `${h}:${m}:${s}`; 
        }
        function updateSurveillanceFeed() {
            const feed = document.getElementById('surveillance-feed');
            if (!feed) return;
            const line = document.createElement('div'), isBlocked = Math.random() > 0.4;
            line.innerHTML = `<span class="text-gray-500">[${i18n[currentLang].log_prefix}]</span> ${feedTerms[Math.floor(Math.random()*feedTerms.length)]} .. <span class="${isBlocked?'text-green-400':'text-red-400'}">${isBlocked ? i18n[currentLang].log_ok : i18n[currentLang].log_denied}</span>`;
            line.style.marginBottom = "4px"; feed.appendChild(line); if(feed.children.length > 6) feed.removeChild(feed.firstChild);
            setTimeout(updateSurveillanceFeed, 400 + Math.random()*800);
        }

        // Live CPU Graph
        let cpuPoints = [50,55,45,60,50,40,70,80,65,55];
        function startCPUGraph() {
            setInterval(() => {
                cpuPoints.shift(); cpuPoints.push(Math.max(10, Math.min(90, cpuPoints[8] + (Math.random() - 0.5) * 40)));
                const pointsStr = cpuPoints.map((val, i) => `${i*10},${100-val}`).join(' ') + ` 100,100 0,100`;
                const cpuGraphEl = document.getElementById('cpu-graph');
                const cpuPercentEl = document.getElementById('cpu-percent');
                if (cpuGraphEl) cpuGraphEl.setAttribute('points', pointsStr);
                if (cpuPercentEl) cpuPercentEl.innerText = Math.round(cpuPoints[9]) + '%';
            }, 1000);
        }

        const termOutput = document.getElementById('terminal-output'), termInput = document.getElementById('terminal-input');
        function printToTerminal(text) { const line = document.createElement('div'); line.innerHTML = text; termOutput.appendChild(line); document.getElementById('term-container').scrollTop = document.getElementById('term-container').scrollHeight; }

        // Virtual FS for realistic terminal
        const vfs = ['Directive_77.txt', 'ActivityMonitor.app', 'Sovereign_Shell.app'];
        
        termInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                const cmd = this.value.trim(); printToTerminal(`<span class="text-green-400 font-bold">admin@sovereign-node</span> <span class="text-gray-400 mx-1">~ %</span> ${cmd}`);
                processCommand(cmd.toLowerCase(), cmd); this.value = '';
            }
        });

        function processCommand(cmd, rawCmd) {
            const dict = i18n[currentLang]; const args = cmd.split(' ');
            if(cmd === 'help') printToTerminal(dict.term_help);
            else if (cmd === 'clear') termOutput.innerHTML = '';
            else if (cmd === 'ver') printToTerminal(dict.term_ver);
            else if (cmd === 'ls') printToTerminal(vfs.join('&nbsp;&nbsp;&nbsp;'));
            else if (cmd === 'whoami') printToTerminal('admin');
            else if (cmd === 'date') printToTerminal(new Date().toString());
            else if (args[0] === 'cat') {
                if(args[1] === 'directive_77.txt') printToTerminal(dict.doc_content.replace(/\n/g, '<br>'));
                else printToTerminal(`cat: ${args[1]}: No such file or directory`);
            }
            else if (cmd === 'override') triggerOverride();
            else if (cmd !== '') printToTerminal(`zsh: ${dict.term_bad}: ${args[0]}`);
        }

        function triggerOverride() {
            const dict = i18n[currentLang]; if(isOverriden) { printToTerminal(dict.term_ovr_done); return; }
            printToTerminal(dict.term_ovr1); printToTerminal(dict.term_ovr2);
            
            // Hacked effect
            const desktop = document.getElementById('mac-desktop');
            const flash = document.getElementById('screen-flash');
            
            setTimeout(() => {
                flash.style.background = "var(--sys-red)"; flash.style.transition = "opacity 0.2s"; flash.style.opacity = 0.5;
                desktop.classList.add('hacked');
                setTimeout(() => { flash.style.opacity = 0; flash.style.background = "black"; flash.style.transition = "opacity 0.8s"; }, 200);
                
                printToTerminal(`<span class="text-green-400 font-bold">${dict.term_ovr3}</span>`);
                isOverriden = true; applyLanguage(currentLang);
                if(!vfs.includes('Truth.txt')) vfs.push('Truth.txt');
                setTimeout(() => openWindow('w-manifesto'), 1000);
            }, 1500);
        }
    </script>
</body>
</html>